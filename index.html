<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Chamado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .ts-control { border-radius: 0.375rem; border-color: #d1d5db; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .ts-wrapper.focus .ts-control { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); }
    </style>
</head>
<body class="p-6">
    <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-6">
            <img src="./eBA - Splash.png" alt="Logo 1" class="h-10">
            <img src="./iGUT Clínicas - LOGO.png" alt="Logo 2" class="h-10">
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Novo Chamado de Suporte</h2>
        <form id="issue-form">
            <div class="space-y-4">
                <div>
                    <label for="modelo" class="block text-sm font-medium text-gray-700">Escolha um Modelo</label>
                    <select id="modelo" name="modelo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                        <option value="">Nenhum</option>
                        <option value="migracao">MIGRAÇÃO</option>
                        <option value="novo-sistema">NOVO SISTEMA</option>
                        <option value="solicitacao">SOLICITAÇÃO</option>
                    </select>
                </div>
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">Título do Chamado</label>
                    <input type="text" id="title" name="title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Descrição Detalhada</label>
                    <textarea id="description" name="description" rows="8" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"></textarea>
                </div>
                <div>
                    <label for="milestone" class="block text-sm font-medium text-gray-700">Milestone</label>
                    <select id="milestone" name="milestone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div>
                    <label for="assignee" class="block text-sm font-medium text-gray-700">Responsável (Assignee)</label>
                    <select id="assignee" name="assignee" multiple class="mt-1 block w-full">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div>
                    <label for="labels" class="block text-sm font-medium text-gray-700">Etiquetas (Labels)</label>
                    <select id="labels" name="labels" multiple class="mt-1 block w-full">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Criar Chamado
                    </button>
                    <p id="status-message" class="text-sm font-medium text-gray-600 hidden"></p>
                </div>
            </div>
        </form>
    </div>

   <script>
    document.addEventListener('DOMContentLoaded', function() {
        const GITHUB_REPO = 'douglaspootz/suporte';
        const webhookUrl = 'https://n8n.igut.med.br/webhook/tarefas_suporte';
        const webhookUrlBuscar = 'https://n8n.igut.med.br/webhook/buscar_dados';

        const modelos = {
            'migracao': {
                title: "[MIGRACAO] Clínica X",
                body: "Nome da clínica(sistema):\n\nObs: Sistema da clinica informada sera migrado do servidor de implantacao para topologia operacional"
            },
            'novo-sistema': {
                title: "[NOVO SISTEMA] Clínica X",
                body: "Nome da clínica(sistema):\nDomínio da clínica: clinica.igutclinicas.com.br\n\nObs: O novo sistema será criado no servidor de implantação\nDomínio será o informado na issue\nBD será igutclinicas_nomedaclinica"
            },
            'solicitacao': {
                title: "[SOLICITAÇÃO] ",
                body: "Informações/solicitações"
            }
        };
        
        const modeloSelect = document.getElementById('modelo');
        const titleInput = document.getElementById('title');
        const descriptionTextarea = document.getElementById('description');

        modeloSelect.addEventListener('change', function() {
            const modeloSelecionado = this.value;
            if (modelos[modeloSelecionado]) {
                titleInput.value = modelos[modeloSelecionado].title;
                descriptionTextarea.value = modelos[modeloSelecionado].body;
            } else {
                titleInput.value = "";
                descriptionTextarea.value = "";
            }
        });

        const assigneeTomSelect = new TomSelect('#assignee', {});
        const labelsTomSelect = new TomSelect('#labels', {});
        const milestoneSelect = document.getElementById('milestone');
        async function fetchMilestones() {
            const response = await fetch(`${webhookUrlBuscar}?action=getMilestones`);
            const milestones = await response.json();
            milestoneSelect.innerHTML = '<option value="">Selecione a Milestone</option>';
            milestones.forEach(m => {
                const option = document.createElement('option');
                option.value = m.number;
                option.textContent = m.title;
                milestoneSelect.appendChild(option);
            });
        }

        async function fetchAssignees() {
            const response = await fetch(`${webhookUrlBuscar}?action=getAssignees`);
            const assignees = await response.json();
            assigneeTomSelect.clearOptions();
            assignees.forEach(a => {
                assigneeTomSelect.addOption({ value: a.login, text: a.login });
            });
            assigneeTomSelect.refreshOptions(false);
        }

        async function fetchLabels() {
            const response = await fetch(`${webhookUrlBuscar}?action=getLabels`);
            const labels = await response.json();
            labelsTomSelect.clearOptions();
            labels.forEach(l => {
                labelsTomSelect.addOption({ value: l.name, text: l.name });
            });
            labelsTomSelect.refreshOptions(false);
        }

        fetchMilestones();
        fetchAssignees();
        fetchLabels();

        document.getElementById('issue-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const form = event.target;
            const statusMessage = document.getElementById('status-message');

            const data = {
                title: form.title.value,
                description: form.description.value,
                milestone: form.milestone.value,
                assignees: assigneeTomSelect.getValue(),
                labels: labelsTomSelect.getValue()
            };

            statusMessage.textContent = 'Enviando...';
            statusMessage.classList.remove('hidden', 'text-green-500', 'text-red-500');

            fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    statusMessage.textContent = 'Chamado criado com sucesso!';
                    statusMessage.classList.add('text-green-500');
                    form.reset();
                    assigneeTomSelect.clear();
                    labelsTomSelect.clear();
                    modeloSelect.value = "";
                } else {
                    statusMessage.textContent = 'Erro ao criar o chamado. Tente novamente.';
                    statusMessage.classList.add('text-red-500');
                }
            })
            .catch(error => {
                statusMessage.textContent = 'Erro de conexão: ' + error.message;
                statusMessage.classList.add('text-red-500');
            })
            .finally(() => {
                setTimeout(() => { statusMessage.classList.add('hidden'); }, 5000);
            });
        });
    });
</script>
</body>
</html>
